<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Flare Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: #ff6b35 #191919;
        }

        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            background: #191919;
            color: #e6edf3;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #191919;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff6b35;
            border-radius: 6px;
        }

        nav.tabs {
            display: flex;
            align-items: center;
            background: #191919;
            padding: 6px 0 6px 10px;
            gap: 4px;
            border-bottom: 1px solid #1e1e1e;
            min-height: 34px;
            overflow-x: auto;
        }

        nav.tabs button {
            background: #1e1e1e;
            border: 2px solid #2a2a2a;
            padding: 5px 11px;
            border-radius: 6px;
            font-size: 0.7rem;
            color: #8b949e;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            opacity: 0;
            transform: translateY(0);
            animation: fadeInTab 0.3s forwards;
            transition: transform 0.15s ease-in-out, background 0.15s, border 0.15s, color 0.15s;
            position: relative;
        }

        nav.tabs button.active {
            background: #1e1e1e;
            border: 2px solid #ff6b35;
            color: #ff8555;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
            transform: translateY(2px);
        }

        nav.tabs button:hover:not(.active) {
            background: #1e1e1e;
            border-color: #ff8555;
            color: #c9d1d9;
        }

        nav.tabs button:active {
            transform: translateY(2px);
        }

        @keyframes fadeInTab {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOutTab {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-8px); }
        }

        nav.tabs button.closing {
            animation: fadeOutTab 0.3s forwards;
        }

        nav.tabs .close-btn {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-left: 4px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: inherit;
            transition: opacity 0.2s ease;
        }

        nav.tabs .close-btn:hover {
            opacity: 1;
        }

        nav.tabs .add-tab {
            width: 20px;
            height: 20px;
            font-size: 0.6rem;
            color: #ff8555;
            background: #1e1e1e;
            border: 1px solid #2a2a2a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-left: 6px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        nav.tabs .add-tab:hover {
            background: #1e1e1e;
            color: #ff6b35;
            border-color: #ff6b35;
            transform: scale(1.1);
        }

        nav.tabs .add-tab i { font-size: 0.6rem; pointer-events: none; }

        #editors-container {
            flex: 1;
            position: relative;
            background: #191919;
        }

        .editor-instance {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
        }

        .editor-instance.active { display: block; z-index: 1; }

        .tab-content { display: flex; align-items: center; gap: 5px; }

        .tab-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100px;
        }

        input.rename-input {
            font-family: 'Poppins', sans-serif;
            font-size: 0.7rem;
            background: #1e1e1e;
            color: #e6edf3;
            border: 1px solid #ff6b35;
            border-radius: 4px;
            padding: 2px 6px;
            width: 100px;
        }
    </style>
</head>
<body>
    <nav class="tabs" id="tabs">
        <button class="add-tab" id="addTabBtn"><i class="fas fa-plus"></i></button>
    </nav>
    <div id="editors-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let models = {}, editors = {}, activeTab = null, fileCounter = 1, monacoInstance;
        let currentAccentColor = '#ff8555'; // Track current accent color
        const tabsContainer = document.getElementById('tabs');
        const editorsContainer = document.getElementById('editors-container');

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], () => {
            monacoInstance = monaco;

            monaco.editor.defineTheme('flareTheme', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '6e7681', fontStyle: 'italic' },
                    { token: 'keyword', foreground: 'ff8555', fontStyle: 'bold' },
                    { token: 'string', foreground: 'ffa657' },
                    { token: 'number', foreground: 'ffa657' },
                    { token: 'function', foreground: 'ffb366' },
                    { token: 'variable', foreground: 'ff9a4d' },
                ],
                colors: {
                    'editor.background': '#191919',
                    'editor.foreground': '#e6edf3',
                    'editor.lineHighlightBackground': '#1e1e1e',
                    'editorLineNumber.foreground': '#6e7681',
                    'editorLineNumber.activeForeground': '#ff8555',
                    'editor.selectionBackground': '#ff6b354d',
                    'editor.inactiveSelectionBackground': '#ff6b3526',
                    'editorCursor.foreground': '#ff8555',
                }
            });

            addNewTab('main.lua');
        });

        function addNewTab(name) {
            const filename = name || `main${fileCounter++}.lua`;
            const model = monacoInstance.editor.createModel('print("Flare")', 'lua');
            models[filename] = model;
            const editorDiv = document.createElement('div');
            editorDiv.id = `editor-${filename}`;
            editorDiv.className = 'editor-instance';
            editorsContainer.appendChild(editorDiv);
            editors[filename] = monacoInstance.editor.create(editorDiv, {
                model: model,
                theme: 'flareTheme',
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Consolas', 'Courier New', monospace",
                fontLigatures: true,
                automaticLayout: true,
                cursorSmoothCaretAnimation: 'on',
                cursorBlinking: 'smooth'
            });

            createTab(filename);
            switchTab(filename);
        }

        function createTab(filename) {
            const tab = document.createElement('button');
            tab.dataset.file = filename;
            const tabContent = document.createElement('div');
            tabContent.className = 'tab-content';
            const icon = document.createElement('i');
            icon.className = 'fas fa-fire';
            const label = document.createElement('span');
            label.className = 'tab-label';
            label.textContent = filename;
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = e => { e.stopPropagation(); closeTab(filename, tab); };
            tabContent.appendChild(icon);
            tabContent.appendChild(label);
            tab.appendChild(tabContent);
            tab.appendChild(closeBtn);
            tab.onclick = () => { if (!tab.querySelector('input.rename-input')) switchTab(filename); };
            tab.ondblclick = e => { e.stopPropagation(); renameTab(tab, label); };
            tabsContainer.insertBefore(tab, document.getElementById('addTabBtn'));
        }

        function switchTab(filename) {
            if (!models[filename]) return;
            activeTab = filename;
            [...tabsContainer.children].forEach(tab => {
                const isActive = tab.dataset.file === filename;
                tab.classList.toggle('active', isActive);
                
                // Apply current accent color to active tab
                if (isActive) {
                    tab.style.borderColor = currentAccentColor;
                    tab.style.color = currentAccentColor;
                }
            });
            [...editorsContainer.children].forEach(div => div.classList.remove('active'));
            const activeDiv = document.getElementById(`editor-${filename}`);
            if (activeDiv) activeDiv.classList.add('active');
        }

        function closeTab(filename, tab) {
            tab.classList.add('closing');
            setTimeout(() => tab.remove(), 300);
            if (editors[filename]) { editors[filename].dispose(); delete editors[filename]; }
            if (models[filename]) { models[filename].dispose(); delete models[filename]; }
            document.getElementById(`editor-${filename}`)?.remove();
            if (activeTab === filename) {
                const remaining = Object.keys(models);
                if (remaining.length > 0) switchTab(remaining[0]);
                else activeTab = null;
            }
        }

        function renameTab(tab, label) {
            const oldFilename = tab.dataset.file;
            const input = document.createElement('input');
            input.className = 'rename-input';
            input.type = 'text';
            input.value = oldFilename;
            label.replaceWith(input);
            input.focus();
            input.select();

            const finishRename = () => {
                const newFilename = input.value.trim() || oldFilename;
                if (newFilename !== oldFilename && !models[newFilename]) {
                    models[newFilename] = models[oldFilename];
                    editors[newFilename] = editors[oldFilename];
                    delete models[oldFilename];
                    delete editors[oldFilename];
                    tab.dataset.file = newFilename;
                    const editorDiv = document.getElementById(`editor-${oldFilename}`);
                    if (editorDiv) editorDiv.id = `editor-${newFilename}`;
                    if (activeTab === oldFilename) activeTab = newFilename;
                }
                const newLabel = document.createElement('span');
                newLabel.className = 'tab-label';
                newLabel.textContent = tab.dataset.file;
                input.replaceWith(newLabel);
            };

            input.addEventListener('blur', finishRename);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') finishRename();
                if (e.key === 'Escape') { input.value = oldFilename; finishRename(); }
            });
        }

        document.getElementById('addTabBtn').onclick = () => addNewTab();

        window.getEditorValue = () => activeTab ? editors[activeTab].getValue() : '';
        window.setEditorValue = content => { if (activeTab) editors[activeTab].setValue(content); };

        // --- THEME CHANGER FROM C# ---
        window.setThemeColors = theme => {
            let colors = { background: '#191919', foreground: '#e6edf3', accent: '#ff8555', scrollbar: '#ff6b35' };
            
            switch(theme) {
                case 'black': 
                    colors = { background: '#0d0d0d', foreground: '#ffffff', accent: '#ff6b35', scrollbar: '#ff6b35' }; 
                    break;
                case 'blue': 
                    colors = { background: '#0b1e4f', foreground: '#e0e8ff', accent: '#4da6ff', scrollbar: '#4da6ff' }; 
                    break;
                case 'green': 
                    colors = { background: '#0d250d', foreground: '#e6ffe6', accent: '#3fff3f', scrollbar: '#3fff3f' }; 
                    break;
                case 'red': 
                    colors = { background: '#2a0d0d', foreground: '#ffe6e6', accent: '#ff3f3f', scrollbar: '#ff3f3f' }; 
                    break;
                case 'pink': 
                    colors = { background: '#2d0d1a', foreground: '#ffe6f0', accent: '#ff6bbd', scrollbar: '#ff6bbd' }; 
                    break;
                case 'white': 
                    colors = { background: '#f8f8f8', foreground: '#1a1a1a', accent: '#ff8555', scrollbar: '#ff8555' }; 
                    break;
                case 'yellow': 
                    colors = { background: '#2a2a0d', foreground: '#ffffd9', accent: '#ffea3f', scrollbar: '#ffea3f' }; 
                    break;
            }

            // Store current accent color
            currentAccentColor = colors.accent;

            // Update body & container colors
            document.body.style.background = colors.background;
            document.body.style.color = colors.foreground;
            
            // Update scrollbar
            document.documentElement.style.setProperty('scrollbar-color', `${colors.scrollbar} ${colors.background}`);
            
            // Update tabs navigation
            const navTabs = document.querySelector('nav.tabs');
            if (navTabs) {
                navTabs.style.background = colors.background;
                navTabs.style.borderBottomColor = colors.accent + '33';
            }
            
            // Update editors container
            const editorsContainer = document.getElementById('editors-container');
            if (editorsContainer) {
                editorsContainer.style.background = colors.background;
            }
            
            // Update only active tab with accent color, leave inactive tabs alone
            [...document.querySelectorAll('nav.tabs button')].forEach(btn => {
                if (btn.classList.contains('active')) {
                    btn.style.borderColor = colors.accent;
                    btn.style.color = colors.accent;
                }
                // Don't update inactive tabs - they keep default colors
            });
            
            // Update add tab button
            const addTabBtn = document.querySelector('.add-tab');
            if (addTabBtn) {
                addTabBtn.style.color = colors.accent;
                addTabBtn.style.borderColor = colors.accent + '66';
            }

            // Update CSS custom properties for scrollbar
            const style = document.createElement('style');
            style.textContent = `
                ::-webkit-scrollbar-track { background: ${colors.background}; }
                ::-webkit-scrollbar-thumb { background: ${colors.scrollbar}; }
            `;
            document.head.appendChild(style);

            // Update Monaco editor theme dynamically
            if (monacoInstance) {
                monacoInstance.editor.defineTheme('flareTheme', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '6e7681', fontStyle: 'italic' },
                        { token: 'keyword', foreground: colors.accent.replace('#',''), fontStyle: 'bold' },
                        { token: 'string', foreground: 'ffa657' },
                        { token: 'number', foreground: 'ffa657' },
                        { token: 'function', foreground: 'ffb366' },
                        { token: 'variable', foreground: 'ff9a4d' },
                    ],
                    colors: {
                        'editor.background': colors.background,
                        'editor.foreground': colors.foreground,
                        'editor.lineHighlightBackground': colors.background + 'dd',
                        'editorLineNumber.foreground': '#6e7681',
                        'editorLineNumber.activeForeground': colors.accent,
                        'editor.selectionBackground': colors.accent + '4d',
                        'editor.inactiveSelectionBackground': colors.accent + '26',
                        'editorCursor.foreground': colors.accent,
                        'scrollbarSlider.background': colors.scrollbar + '99',
                        'scrollbarSlider.hoverBackground': colors.scrollbar + 'cc',
                        'scrollbarSlider.activeBackground': colors.scrollbar,
                    }
                });
                Object.values(editors).forEach(ed => ed.updateOptions({ theme: 'flareTheme' }));
            }
        };
    </script>
</body>
</html>
