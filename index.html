<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Catexp Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: #3a3a3a #191919;
        }

        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            background: #191919;
            color: #e6edf3;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #191919;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        nav.tabs {
            display: flex;
            align-items: center;
            background: #1e1e1e;
            padding: 6px 0 6px 10px;
            gap: 4px;
            border-bottom: 1px solid #2a2a2a;
            min-height: 34px;
            overflow-x: auto;
        }

        nav.tabs button {
            background: #1e1e1e;
            border: 2px solid #2a2a2a;
            padding: 5px 11px;
            border-radius: 6px;
            font-size: 0.7rem;
            color: #8b949e;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            opacity: 0;
            transform: translateY(0);
            animation: fadeInTab 0.3s forwards;
            transition: transform 0.15s ease-in-out, background 0.15s, border 0.15s, color 0.15s;
            position: relative;
        }

        nav.tabs button.active {
            background: #252525;
            border: 2px solid #505050;
            color: #c9d1d9;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
            transform: translateY(2px);
        }

        nav.tabs button:hover:not(.active) {
            background: #252525;
            border-color: #404040;
            color: #c9d1d9;
        }

        nav.tabs button:active {
            transform: translateY(2px);
        }

        @keyframes fadeInTab {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOutTab {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-8px); }
        }

        nav.tabs button.closing {
            animation: fadeOutTab 0.3s forwards;
        }

        nav.tabs .close-btn {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-left: 4px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: inherit;
            transition: opacity 0.2s ease;
        }

        nav.tabs .close-btn:hover {
            opacity: 1;
        }

        nav.tabs .add-tab {
            width: 20px;
            height: 20px;
            font-size: 0.6rem;
            color: #8b949e;
            background: #1e1e1e;
            border: 1px solid #2a2a2a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-left: 6px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        nav.tabs .add-tab:hover {
            background: #252525;
            color: #c9d1d9;
            border-color: #404040;
            transform: scale(1.1);
        }

        nav.tabs .add-tab i { font-size: 0.6rem; pointer-events: none; }

        #editors-container {
            flex: 1;
            position: relative;
            background: #191919;
        }

        .editor-instance {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
        }

        .editor-instance.active { display: block; z-index: 1; }

        .tab-content { display: flex; align-items: center; gap: 5px; }

        .tab-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100px;
        }

        input.rename-input {
            font-family: 'Poppins', sans-serif;
            font-size: 0.7rem;
            background: #1e1e1e;
            color: #e6edf3;
            border: 1px solid #505050;
            border-radius: 4px;
            padding: 2px 6px;
            width: 100px;
        }
    </style>
</head>
<body>
    <nav class="tabs" id="tabs">
        <button class="add-tab" id="addTabBtn"><i class="fas fa-plus"></i></button>
    </nav>
    <div id="editors-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let models = {}, editors = {}, activeTab = null, fileCounter = 1, monacoInstance;
        let currentAccentColor = '#6a6a6a'; // Track current accent color
        const tabsContainer = document.getElementById('tabs');
        const editorsContainer = document.getElementById('editors-container');

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], () => {
            monacoInstance = monaco;

            monaco.editor.defineTheme('catexpTheme', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '6e7681', fontStyle: 'italic' },
                    { token: 'keyword', foreground: '9cdcfe', fontStyle: 'bold' },
                    { token: 'string', foreground: 'ce9178' },
                    { token: 'number', foreground: 'b5cea8' },
                    { token: 'function', foreground: 'dcdcaa' },
                    { token: 'variable', foreground: '9cdcfe' },
                ],
                colors: {
                    'editor.background': '#191919',
                    'editor.foreground': '#d4d4d4',
                    'editor.lineHighlightBackground': '#1e1e1e',
                    'editorLineNumber.foreground': '#6e7681',
                    'editorLineNumber.activeForeground': '#c9d1d9',
                    'editor.selectionBackground': '#3a3a3a',
                    'editor.inactiveSelectionBackground': '#2a2a2a',
                    'editorCursor.foreground': '#c9d1d9',
                    'editorIndentGuide.background': '#2a2a2a',
                    'editorIndentGuide.activeBackground': '#3a3a3a',
                }
            });

            addNewTab('main.lua');
        });

        function addNewTab(name) {
            const filename = name || `main${fileCounter++}.lua`;
            const model = monacoInstance.editor.createModel('print("catexp.xyz")', 'lua');
            models[filename] = model;
            const editorDiv = document.createElement('div');
            editorDiv.id = `editor-${filename}`;
            editorDiv.className = 'editor-instance';
            editorsContainer.appendChild(editorDiv);
            editors[filename] = monacoInstance.editor.create(editorDiv, {
                model: model,
                theme: 'catexpTheme',
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Consolas', 'Courier New', monospace",
                fontLigatures: true,
                automaticLayout: true,
                cursorSmoothCaretAnimation: 'on',
                cursorBlinking: 'smooth',
                minimap: { enabled: false },
                scrollbar: {
                    vertical: 'auto',
                    horizontal: 'auto',
                    verticalScrollbarSize: 8,
                    horizontalScrollbarSize: 8
                }
            });

            createTab(filename);
            switchTab(filename);
        }

        function createTab(filename) {
            const tab = document.createElement('button');
            tab.dataset.file = filename;
            const tabContent = document.createElement('div');
            tabContent.className = 'tab-content';
            const icon = document.createElement('i');
            icon.className = 'fas fa-file-code';
            const label = document.createElement('span');
            label.className = 'tab-label';
            label.textContent = filename;
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = e => { e.stopPropagation(); closeTab(filename, tab); };
            tabContent.appendChild(icon);
            tabContent.appendChild(label);
            tab.appendChild(tabContent);
            tab.appendChild(closeBtn);
            tab.onclick = () => { if (!tab.querySelector('input.rename-input')) switchTab(filename); };
            tab.ondblclick = e => { e.stopPropagation(); renameTab(tab, label); };
            tabsContainer.insertBefore(tab, document.getElementById('addTabBtn'));
        }

        function switchTab(filename) {
            if (!models[filename]) return;
            activeTab = filename;
            [...tabsContainer.children].forEach(tab => {
                const isActive = tab.dataset.file === filename;
                tab.classList.toggle('active', isActive);
                
                // Apply current accent color to active tab only
                if (isActive) {
                    tab.style.borderColor = currentAccentColor;
                    tab.style.color = '#c9d1d9';
                }
            });
            [...editorsContainer.children].forEach(div => div.classList.remove('active'));
            const activeDiv = document.getElementById(`editor-${filename}`);
            if (activeDiv) activeDiv.classList.add('active');
        }

        function closeTab(filename, tab) {
            tab.classList.add('closing');
            setTimeout(() => tab.remove(), 300);
            if (editors[filename]) { editors[filename].dispose(); delete editors[filename]; }
            if (models[filename]) { models[filename].dispose(); delete models[filename]; }
            document.getElementById(`editor-${filename}`)?.remove();
            if (activeTab === filename) {
                const remaining = Object.keys(models);
                if (remaining.length > 0) switchTab(remaining[0]);
                else activeTab = null;
            }
        }

        function renameTab(tab, label) {
            const oldFilename = tab.dataset.file;
            const input = document.createElement('input');
            input.className = 'rename-input';
            input.type = 'text';
            input.value = oldFilename;
            label.replaceWith(input);
            input.focus();
            input.select();

            const finishRename = () => {
                const newFilename = input.value.trim() || oldFilename;
                if (newFilename !== oldFilename && !models[newFilename]) {
                    models[newFilename] = models[oldFilename];
                    editors[newFilename] = editors[oldFilename];
                    delete models[oldFilename];
                    delete editors[oldFilename];
                    tab.dataset.file = newFilename;
                    const editorDiv = document.getElementById(`editor-${oldFilename}`);
                    if (editorDiv) editorDiv.id = `editor-${newFilename}`;
                    if (activeTab === oldFilename) activeTab = newFilename;
                }
                const newLabel = document.createElement('span');
                newLabel.className = 'tab-label';
                newLabel.textContent = tab.dataset.file;
                input.replaceWith(newLabel);
            };

            input.addEventListener('blur', finishRename);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') finishRename();
                if (e.key === 'Escape') { input.value = oldFilename; finishRename(); }
            });
        }

        document.getElementById('addTabBtn').onclick = () => addNewTab();

        window.getEditorValue = () => activeTab ? editors[activeTab].getValue() : '';
        window.setEditorValue = content => { if (activeTab) editors[activeTab].setValue(content); };

        // --- THEME CHANGER FROM C# ---
        window.setThemeColors = theme => {
            let accent = '#6a6a6a';
            
            switch(theme) {
                case 'black': accent = '#c8c8c8'; break;
                case 'blue': accent = '#4da6ff'; break;
                case 'green': accent = '#3fff3f'; break;
                case 'red': accent = '#ff3f3f'; break;
                case 'pink': accent = '#ff6bbd'; break;
                case 'white': accent = '#323232'; break;
                case 'yellow': accent = '#ffea3f'; break;
                case 'orange': accent = '#ff8555'; break;
                default: accent = '#6a6a6a'; break;
            }

            // Store current accent color
            currentAccentColor = accent;

            // Update ONLY the active tab
            [...document.querySelectorAll('nav.tabs button')].forEach(btn => {
                if (btn.classList.contains('active')) {
                    btn.style.borderColor = accent;
                }
            });
            
            // Update add tab button hover color
            const addTabBtn = document.querySelector('.add-tab');
            if (addTabBtn) {
                addTabBtn.style.borderColor = '#2a2a2a';
            }

            // Update Monaco editor theme dynamically
            if (monacoInstance) {
                monacoInstance.editor.defineTheme('catexpTheme', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '6e7681', fontStyle: 'italic' },
                        { token: 'keyword', foreground: accent.replace('#',''), fontStyle: 'bold' },
                        { token: 'string', foreground: 'ce9178' },
                        { token: 'number', foreground: 'b5cea8' },
                        { token: 'function', foreground: 'dcdcaa' },
                        { token: 'variable', foreground: '9cdcfe' },
                    ],
                    colors: {
                        'editor.background': '#191919',
                        'editor.foreground': '#d4d4d4',
                        'editor.lineHighlightBackground': '#1e1e1e',
                        'editorLineNumber.foreground': '#6e7681',
                        'editorLineNumber.activeForeground': accent,
                        'editor.selectionBackground': accent + '4d',
                        'editor.inactiveSelectionBackground': accent + '26',
                        'editorCursor.foreground': accent,
                        'editorIndentGuide.background': '#2a2a2a',
                        'editorIndentGuide.activeBackground': '#3a3a3a',
                    }
                });
                Object.values(editors).forEach(ed => ed.updateOptions({ theme: 'catexpTheme' }));
            }
        };
    </script>
</body>
</html>
